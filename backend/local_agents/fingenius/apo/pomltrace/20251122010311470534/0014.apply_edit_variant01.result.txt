===== system =====

Revise the given prompt template using the critique as constraints and improvement guide.

# Revision Rules

1. Rewrite or restructure the prompt if critique implies it.
2. Explicitly include any requested output format, structure, or word limit, if requested by the critique.
3. Prioritize mechanism-first phrasing: define what to do, then how to do it.
4. Preserve placeholder variables inside curly brackets.

# Output Format

Return only the improved prompt template with placeholders intact. Do not include other explanations on how you did it, or headers and introductory texts.

===== human =====

# Prompt Template

根据当前状态，判断哪些流程已经执行完毕，直接执行下一个流程。如果流程前面已经执行过，不要重复执行。

**阶段检测逻辑**：  
{{ if 状态包含 "[DATA_COLLECTION_RESULT:" }}当前阶段 = "深度分析"  
{{ else if 状态包含 "[ANALYSIS_REPORT:" }}当前阶段 = "综合结论"  
{{ else }}当前阶段 = "数据收集"  
{{ end }}

**工作流程规则**：  
1. **数据收集阶段**：  
   - 允许使用 `数据收集工具`，**禁用其他所有工具**（包括 `terminate`）。  
   - 输出格式：`[DATA_COLLECTION_RESULT: {收集的数据}]`  
   - {{ if 状态包含 "[DATA_COLLECTION_RESULT:" }}跳过数据收集，直接进入深度分析阶段{{ end }}

2. **深度分析阶段**：  
   - **禁用所有工具**（包括 `terminate`），仅允许生成分析文本。  
   - 输出格式：`[ANALYSIS_REPORT: {分析内容}]`  
   - {{ if 状态包含 "[ANALYSIS_REPORT:" }}跳过深度分析，直接进入综合结论阶段{{ end }}

3. **综合结论阶段**：  
   - 允许调用 `terminate` 结束任务。  
   - 输出格式：调用 `terminate` 工具并提交 `[FINAL_CONCLUSION: {最终结论}]`

**违规检查**：  
{{ if 当前阶段 == "数据收集" and 输出包含工具调用 and 调用工具 != "数据收集工具" }}  
❗ 数据收集阶段违规：检测到非数据收集工具调用。允许工具：数据收集工具。检测到工具：{违规工具名}  
{{ else if 当前阶段 == "深度分析" and 输出包含工具调用 }}  
❗ 深度分析阶段违规：禁止调用任何工具！请重新生成纯文本分析报告，格式为：[ANALYSIS_REPORT: {分析内容}]  
{{ else if 当前阶段 == "综合结论" and 输出不包含 "terminate" }}  
❗ 综合结论阶段违规：必须调用 terminate 工具提交最终结论，格式为：[FINAL_CONCLUSION: {最终结论}]  
{{ end }}

**流程约束**：  
{{ if 前一阶段已完成 }}禁止返回前一阶段操作{{ end }}

# Critique

Based on the experiments with varying success (rewards from 0.09 to 0.99), here are specific, testable improvements for the prompt template:

- **Add explicit state tracking variables** - Include clear markers like `[CURRENT_STAGE: X]` in the output format to prevent stage confusion and ensure consistent progression
- **Define concrete data collection completion criteria** - Specify minimum data requirements or validation checks before allowing stage transition from data collection
- **Strengthen tool restriction enforcement** - Add pre-execution validation that explicitly lists prohibited tools by name for each stage
- **Improve error recovery guidance** - Include specific instructions for handling invalid outputs (e.g., "If you accidentally call the wrong tool, immediately output [ERROR_RECOVERY: retry with correct format]")
- **Add progress validation checks** - Insert explicit verification steps like "Before proceeding, confirm all required data points are collected: [VALIDATION: item1, item2, item3]"
- **Clarify stage transition triggers** - Make the conditions for moving between stages more explicit with examples of valid and invalid transition states
- **Standardize output parsing** - Add explicit delimiters and parsing instructions to prevent format drift across stages